CMAKE_MINIMUM_REQUIRED(VERSION 3.8.0)

PROJECT(Trinity.C)

IF(CMAKE_INSTALL_PREFIX_INITIALIZED_TO_DEFAULT)
    SET(CMAKE_INSTALL_PREFIX ${PROJECT_SOURCE_DIR}/../../bin CACHE PATH "..." FORCE)
ENDIF()

INCLUDE_DIRECTORIES(src)
INCLUDE_DIRECTORIES(include)

SET(CMAKE_CXX_STANDARD 14)
SET(CMAKE_CXX_STANDARD_REQUIRED ON)
SET(CMAKE_CXX_EXTENSIONS OFF)
SET(SRC "")
SET(TRINITY_C_INSTALL_PREFIX ".")

FILE(GLOB SRC ${SRC} src/*.cpp)
FILE(GLOB_RECURSE SRC ${SRC} include/*.cpp)
FILE(GLOB_RECURSE SRC ${SRC} src/BackgroundThread/*.cpp)
FILE(GLOB_RECURSE SRC ${SRC} src/Debugger/*.cpp)
FILE(GLOB_RECURSE SRC ${SRC} src/Mathematics/*.cpp)
FILE(GLOB_RECURSE SRC ${SRC} src/Memory/*.cpp)
FILE(GLOB_RECURSE SRC ${SRC} src/Runtime/*.cpp)
FILE(GLOB_RECURSE SRC ${SRC} src/Storage/*.cpp)
FILE(GLOB_RECURSE SRC ${SRC} src/Threading/*.cpp)
FILE(GLOB_RECURSE SRC ${SRC} src/Trinity/*.cpp)
FILE(GLOB_RECURSE SRC ${SRC} src/Utility/*.cpp)
FILE(GLOB SRC ${SRC} src/Network/*.cpp)
FILE(GLOB SRC ${SRC} src/Network/Client/*.cpp)
FILE(GLOB SRC ${SRC} src/Network/Server/*.cpp)

IF(UNIX) 
    FILE(GLOB_RECURSE SRC ${SRC} src/Network/*/posix/*.cpp)

    ADD_LIBRARY(Trinity SHARED ${SRC})

    SET(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -fpermissive -Wall -Wno-write-strings -Wno-unknown-pragmas -pthread")
    ADD_DEFINITIONS(-DTRINITYC_EXPORTS -D_CRT_SECURE_NO_WARNINGS -DUNICODE -D_UNICODE)
    TARGET_COMPILE_DEFINITIONS(Trinity PRIVATE -DCORECLR)
    TARGET_LINK_LIBRARIES(Trinity PRIVATE crypto;ssl)

    INSTALL(TARGETS Trinity DESTINATION ${TRINITY_C_INSTALL_PREFIX})

ELSEIF(WIN32)

    FILE(GLOB_RECURSE SRC ${SRC} src/Network/*/iocp/*.cpp)
    FILE(GLOB_RECURSE SRC ${SRC} src/Network/*/windows/*.cpp)

    ADD_LIBRARY(Trinity   SHARED ${SRC})
    ADD_LIBRARY(Trinity.C SHARED ${SRC})

    SET(CMAKE_CXX_FLAGS         "/volatile:iso /EHa /fp:except- /Zi /Gy /Oi /Ot /Ob2 /MP /Oy /O2 /MT /GS- /W3 /DEBUG")
    SET(CMAKE_CXX_FLAGS_RELEASE "/GL")
    SET(CMAKE_SHARED_LINKER_FLAGS "/LTCG /OPT:REF /OPT:ICF /SUBSYSTEM:WINDOWS /INCREMENTAL:NO")
    ADD_DEFINITIONS(-DTRINITYC_EXPORTS -D_CRT_SECURE_NO_WARNINGS -DUNICODE -D_UNICODE)
    ADD_DEFINITIONS(-DWIN32 -DNDEBUG -D_WINDOWS -D_USRDLL -D_WINSOCK_DEPRECATED_NO_WARNINGS -D_SCL_SECURE_NO_WARNINGS)
    TARGET_COMPILE_DEFINITIONS(Trinity PRIVATE -DCORECLR)
    TARGET_COMPILE_OPTIONS(Trinity   PRIVATE "/Fd Trinity.pdb")
    TARGET_COMPILE_OPTIONS(Trinity.C PRIVATE "/Fd Trinity.C.pdb")

    TARGET_LINK_LIBRARIES(Trinity   PRIVATE Psapi.lib;ws2_32.lib;Dbghelp.lib;Synchronization.lib)
    TARGET_LINK_LIBRARIES(Trinity.C PRIVATE Psapi.lib;ws2_32.lib;Dbghelp.lib;Synchronization.lib)

    INSTALL(TARGETS Trinity   DESTINATION ${TRINITY_C_INSTALL_PREFIX})
    INSTALL(TARGETS Trinity.C DESTINATION ${TRINITY_C_INSTALL_PREFIX})
    INSTALL(FILES ${PROJECT_BINARY_DIR}/Trinity.C.pdb ${PROJECT_BINARY_DIR}/Trinity.pdb DESTINATION ${TRINITY_C_INSTALL_PREFIX})
ENDIF()
